require 'rails_helper'

RSpec.describe User, type: :model do
  # ğŸ’¡ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ã€ã™ã¹ã¦ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æº€ãŸã™æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’äº‹å‰ã«ä½œæˆ
  # FactoryBotã® :user ãƒ•ã‚¡ã‚¯ãƒˆãƒªãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
  let(:valid_user) { FactoryBot.build(:user) }

  ## ğŸ§ª æ­£å¸¸ç³»ã®ãƒ†ã‚¹ãƒˆ
  describe 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²' do
    context 'ç™»éŒ²ã§ãã‚‹å ´åˆ' do
      it 'ã™ã¹ã¦ã®å¿…é ˆé …ç›®ã¨åˆ¶ç´„ãŒæ­£ã—ãå­˜åœ¨ã™ã‚Œã°ç™»éŒ²ã§ãã‚‹ã“ã¨' do
        expect(valid_user).to be_valid
      end
    end
  end

  # âŒ ç•°å¸¸ç³»ã®ãƒ†ã‚¹ãƒˆï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¤œè¨¼ï¼‰
  describe 'ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯' do
    # ----------------------------------------------------
    # 1. å¿…é ˆé …ç›®ï¼ˆpresenceï¼‰ã®ãƒ†ã‚¹ãƒˆ
    # ----------------------------------------------------
    context 'å¿…é ˆé …ç›®ãŒæ¬ ã‘ã¦ã„ã‚‹å ´åˆã€ç™»éŒ²ã§ããªã„' do
      it 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç©ºã§ã¯ç™»éŒ²ã§ããªã„ã“ã¨' do
        valid_user.email = ''
        valid_user.valid?
        # ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé©åˆ‡ã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        expect(valid_user.errors.full_messages).to include('Eãƒ¡ãƒ¼ãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
      end

      it 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒç©ºã§ã¯ç™»éŒ²ã§ããªã„ã“ã¨' do
        valid_user.password = ''
        valid_user.valid?
        expect(valid_user.errors.full_messages).to include('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„')
      end
      # ğŸ’¡ ä»–ã®å¿…é ˆé …ç›®ï¼ˆä¾‹: ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ã€æ°åã€ç”Ÿå¹´æœˆæ—¥ãªã©ï¼‰ã‚‚åŒæ§˜ã«ãƒ†ã‚¹ãƒˆã—ã¾ã™
    end

    # ----------------------------------------------------
    # 2. ä¸€æ„æ€§ï¼ˆuniquenessï¼‰ã®ãƒ†ã‚¹ãƒˆ
    # ----------------------------------------------------
    context 'é‡è¤‡ã«é–¢ã™ã‚‹åˆ¶ç´„' do
      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«æœ‰åŠ¹ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’DBã«ä¿å­˜
      before { valid_user.save }

      it 'é‡è¤‡ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã¯ç™»éŒ²ã§ããªã„ã“ã¨' do
        # æ—¢ã«DBã«å­˜åœ¨ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æŒã¤æ–°ã—ã„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
        user_duplicate = FactoryBot.build(:user, email: valid_user.email)
        user_duplicate.valid?
        # Deviseã®æ—¥æœ¬èªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèª
        expect(user_duplicate.errors.full_messages).to include('Eãƒ¡ãƒ¼ãƒ«ã¯ã™ã§ã«å­˜åœ¨ã—ã¾ã™')
      end
    end

    # ----------------------------------------------------
    # 3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®åˆ¶ç´„ãƒ†ã‚¹ãƒˆï¼ˆé•·ã•ã€ç¢ºèªç”¨ã®ä¸€è‡´ï¼‰
    # ----------------------------------------------------
    context 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ–‡å­—æ•°ã¨ç¢ºèª' do
      it 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒ6æ–‡å­—æœªæº€ã§ã¯ç™»éŒ²ã§ããªã„ã“ã¨ (Deviseã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)' do
        valid_user.password = '12345'
        valid_user.password_confirmation = '12345'
        valid_user.valid?
        expect(valid_user.errors.full_messages).to include('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯6æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„')
      end
      it 'ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæœ¬ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ä¸€è‡´ã—ãªã„ã¨ç™»éŒ²ã§ããªã„ã“ã¨' do
        valid_user.password_confirmation = 'different_password'
        valid_user.valid?
        expect(valid_user.errors.full_messages).to include('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆç¢ºèªç”¨ï¼‰ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å…¥åŠ›ãŒä¸€è‡´ã—ã¾ã›ã‚“')
      end
    end

    # ----------------------------------------------------
    # 4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å½¢å¼åˆ¶ç´„ãƒ†ã‚¹ãƒˆï¼ˆä¾‹: åŠè§’è‹±æ•°æ··åˆï¼‰
    # ----------------------------------------------------
    context 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®å½¢å¼' do
      # ğŸ’¡ ã‚‚ã—ãƒ¢ãƒ‡ãƒ«ã§ã€ŒåŠè§’è‹±æ•°æ··åˆã€ãªã©ã®åˆ¶ç´„ã‚’èª²ã—ã¦ã„ã‚‹å ´åˆ
      # ä¾‹: validates :password, format: { with: /\A(?=.*?[a-z])(?=.*?\d)[a-z\d]+\z/i }
      it 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ•°å­—ã®ã¿ã§ã¯ç™»éŒ²ã§ããªã„ã“ã¨' do
        valid_user.password = '123456'
        valid_user.password_confirmation = '123456'
        valid_user.valid?
        # ğŸ’¡ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ãƒ¢ãƒ‡ãƒ«ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©ã«ä¾å­˜
        # expect(valid_user.errors.full_messages).to include("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯åŠè§’è‹±æ•°ã‚’ä¸¡æ–¹å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™")
      end
    end
  end
end
